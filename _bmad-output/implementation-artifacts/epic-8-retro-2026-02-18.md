# Epic 8 Retrospective — Dashboard, Accounting & Monitoring

**Date**: 2026-02-18
**Epic**: Epic 8 — Dashboard, Accounting & Monitoring (8 stories)
**Facilitator**: Bob (SM)
**Participants**: Alice (PO), Charlie (Dev), Dana (QA), Elena (Junior Dev), Monsieur (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories completed | 8/8 (8.2 absorbed by 8.1) |
| Backend tests (end) | ~1,595 (85 → 110+ suites) |
| Frontend tests (end) | ~878 (47 → 65+ suites) |
| E2E tests added | ~15 new |
| New files | ~115 |
| Modified files | ~85 |
| Review findings total | ~78 across 7 reviews |
| CRITICAL findings | 1 (Story 8.4 — middleware.ts rename reverted) |
| Regressions | 0 |
| New dependencies | Recharts 3.7.0 (charting), xlsx/SheetJS (Excel export), @nestjs/schedule (cron) |

---

## Stories Delivered

| Story | Title | Tests Added | Key Contribution |
|-------|-------|-------------|------------------|
| 8.1 | Event-sourced account book | 42 backend + frontend | Read-only accounting module, QueryBus reference impl |
| 8.2 | View and filter account book | (absorbed by 8.1) | Filters, table, responsive — delivered with 8.1 |
| 8.3 | Export account book as Excel | 36 backend + frontend | ExcelGeneratorService infrastructure, 2072 tax format |
| 8.4 | Dashboard unit payment mosaic | 17 frontend | Month selector, legend, tooltips, tenant names |
| 8.5 | KPIs and collection rate | 18 backend + frontend | DashboardKpisFinder with SQL aggregation, trend indicators |
| 8.6 | Action feed with pending tasks | 12 frontend | Revision alerts, timestamps, formatRelativeDate |
| 8.7 | Treasury chart | 20 backend + frontend | Recharts integration, CSS custom properties dark mode |
| 8.8 | Email alerts for critical events | 47 backend + frontend | @nestjs/schedule cron, AlertPreference + AlertLog models |

---

## What Went Well

### 1. CQRS Compliance on Stories 8.1–8.4, 8.6
Five stories follow CQRS norms (C2-1) correctly:
- Story 8.1 uses full `Controller → QueryBus → Handler → Finder` — **reference implementation**
- PrismaService correctly isolated in Finder layer
- No domain logic in presentation layer
- Story 8.4 and 8.6 are frontend-only (no new backend endpoints)

### 2. Review Process Catching Critical Issues
- Story 8.4 review caught a CRITICAL: middleware.ts rename would have broken Clerk authentication
- Consistent 7-12 findings per story shows stable code quality entering review
- Zero regressions across the entire epic

### 3. New Infrastructure Integration
- **Recharts 3.7.0**: Clean integration with CSS custom properties for dark mode support
- **xlsx/SheetJS**: Stateless ExcelGeneratorService in infrastructure/document/ — proper pattern
- **@nestjs/schedule**: First cron job in project (daily alert detection)

### 4. Dashboard Feature Completeness
- Full piloting dashboard: KPIs, payment mosaic, treasury chart, action feed, email alerts
- Responsive design maintained across all dashboard components
- Dark mode support added systematically

### 5. Accelerating Story Velocity
- 8 stories delivered efficiently
- Story 8.2 absorbed by 8.1 (recognized early, saved a full story cycle)
- Consistent pattern application across read-heavy features (8.5, 8.7)

---

## What Didn't Go Well

### 1. CQRS Violations in Story 8.8 (CRITICAL)
**Audit result**: 3 files, 5 CQRS violations (2 HIGH, 3 MEDIUM)

| File | Violation | Severity |
|------|-----------|----------|
| `AlertPreferenceController` | `prisma.alertPreference.upsert()` directly in controller | HIGH |
| `AlertDetectionService` | 3 direct Prisma queries (rentCall, tenant, escalation) bypassing Finders | MEDIUM |
| `SendAlertsService` | `prisma.ownershipEntity.findMany()` — read bypassing EntityFinder | MEDIUM |
| `SendAlertsService` | `prisma.alertLog.create()` — write bypassing CommandBus/Handler | HIGH |

**Root cause**: AlertPreference/AlertLog don't belong to any existing Bounded Context. Without an aggregate or BC home, the developer short-circuited CQRS patterns. The @nestjs/schedule cron was also a first — no established pattern for cron + CQRS integration.

### 2. Previous Retro Action Items Not Addressed
Epic 7 had 6 action items. At end of Epic 8:
- 0 completed
- 3 partially addressed
- `prisma generate` automation is on its **6th consecutive carry-over**

This is the second consecutive epic with poor action item follow-through.

### 3. CQRS Inconsistency in Stories 8.5 and 8.7 (QueryBus Skipped)
Stories 8.5 (DashboardKpis) and 8.7 (TreasuryChart) use `Controller → Finder` directly, skipping the `QueryBus → Handler` layer established in Story 8.1. While PrismaService is correctly isolated in Finders (not a C2-1 violation), this creates an architectural inconsistency:
- **8.1**: `GetAccountBookController → QueryBus → GetAccountBookHandler → AccountingFinder`
- **8.5**: `GetDashboardKpisController → DashboardKpisFinder` (no Handler)
- **8.7**: `GetTreasuryChartController → TreasuryChartFinder` (no Handler)

Additionally, `DashboardKpisFinder` contains business logic (`computeCollectionRate`, `getOutstandingDebt` aggregation) that should arguably live in a Handler, keeping the Finder as a pure data access layer.

### 4. Systemic Pattern: New Infrastructure = CQRS Drift
When a new infrastructure pattern is introduced (cron scheduling), the developer defaulted to direct Prisma access. This suggests the CQRS norm is pattern-dependent — when an established template exists (controller → QueryBus), it's followed; when no template exists (cron service), it's bypassed.

---

## Key Insights

### Insight 1: CQRS Compliance Correlates with BC Ownership
Stories within established BCs (Portfolio, Tenancy, Billing) maintain CQRS discipline naturally. Cross-cutting concerns without a BC home (alerts, scheduling) are at risk of CQRS drift. **Fix**: Establish explicit patterns for cross-cutting infrastructure modules.

### Insight 2: QueryBus Pattern Not Yet Systematic
Story 8.1 established `Controller → QueryBus → Handler → Finder` as the reference pattern, but Stories 8.5 and 8.7 reverted to the older `Controller → Finder` shortcut. The full QueryBus pattern separates auth/orchestration (Handler) from data access (Finder) and business logic (Handler), but the simpler pattern persists when developers perceive the feature as "just a read endpoint." **Decision needed**: Mandate QueryBus for all new endpoints, or accept Controller → Finder for simple reads?

### Insight 3: Review Process Works but Misses Architectural Norms
Individual story reviews caught functional issues effectively (12 findings on 8.4 including 1 CRITICAL). However, no review flagged the CQRS violations in 8.8 — the user (Monsieur) caught it during the retrospective. **Gap**: Reviews check correctness but not architectural norm compliance.

---

## Previous Retro Action Items Follow-Through (Epic 7)

| ID | Action | Status | Notes |
|----|--------|--------|-------|
| AI-7.1 | Anticipate cross-BC shared structures | Partial | No new cross-BC structures in Epic 8 |
| AI-7.2 | DTO defense-in-depth self-check | Partial | Applied sporadically, not systematic |
| AI-7.3 | useRef guard pattern documentation | Not done | Still undocumented |
| AI-7.4 | Cache key dependency graph | Not done | No progress |
| AI-7.5 | Promise.all on independent Finders | Partial | Applied in 8.1, 8.5, 8.7 |
| AI-7.6 | prisma generate automation | Not done | 6th consecutive carry-over |

**Follow-through rate**: 0/6 completed, 3/6 partial = **0% completion, 50% partial**

---

## Action Items — Epic 8

| ID | Action | Priority | Owner | Status |
|----|--------|----------|-------|--------|
| **AI-8.1** | Normalize CQRS in Story 8.8: AlertPreferenceController → CommandBus, AlertDetectionService → Finders, SendAlertsService → Finders + CommandBus for alertLog writes | **BLOCKING** (Epic 9) | Dev | Open |
| **AI-8.2** | Normalize CQRS in Stories 8.5 + 8.7: Add QueryBus → Handler layer (extract business logic from Finders into Handlers, keep Finders as pure data access) — align with 8.1 reference pattern | **BLOCKING** (Epic 9) | Dev | Open |
| **AI-8.3** | Close or resolve `prisma generate` automation — binary decision: implement a git hook OR explicitly declassify as non-priority | Medium | Dev | Open |
| **AI-8.4** | Document @nestjs/schedule + CQRS integration pattern — cron jobs must use Finders/CommandBus like any other entry point | Medium | Dev | Open |
| **AI-8.5** | Audit and close stale Epic 7 action items — each item gets explicit resolution (done/declassified/deferred with justification) | Low | SM | Open |

---

## Next Epic Readiness — Epic 9: Integrations & Advanced Features

### Epic 9 Stories
1. **9.1** — Connect to Bank via Open Banking API
2. **9.2** — Send Registered Mail via AR24/Maileva Integration
3. **9.3** — Automatic INSEE Index Retrieval
4. **9.4** — Grant Accountant Read-Only Access

### Readiness Checklist

| Criterion | Status | Notes |
|-----------|--------|-------|
| Dashboard features complete | ✅ | All 8 stories delivered |
| CQRS compliance | ❌ BLOCKED | Story 8.8 violations must be fixed (AI-8.1) |
| Test suite stable | ✅ | 1595 backend + 878 frontend, 0 regressions |
| Infrastructure ready | ✅ | Email, PDF, Excel, scheduling all in place |
| External API patterns | ⚠️ | First external integrations — no established pattern |
| Multi-tenant auth model | ⚠️ | Story 9.4 introduces new role (accountant) — arch decision needed |

### Key Risks for Epic 9
1. **External API dependencies**: Open Banking, AR24/Maileva, INSEE — rate limits, auth, error handling
2. **New auth model**: Accountant read-only access requires role-based guards (beyond current single-user model)
3. **CQRS discipline on integrations**: Same risk as 8.8 — external service adapters may bypass CQRS patterns

### Recommendation
**Block Epic 9 until AI-8.1 is resolved.** Create a normalization story (C3-1 or Story 8.8b) to fix CQRS violations before starting external integrations.

---

## Team Agreements

1. **Cron jobs follow CQRS**: All `@Cron` handlers use Finders for reads and CommandBus for writes — no direct PrismaService
2. **Cross-cutting modules need BC assignment**: AlertPreference/AlertLog should be assigned to a BC or get their own presentation module with proper Finders
3. **Review checklist includes CQRS audit**: Code reviews must explicitly verify no PrismaService in controllers/handlers/services (outside Finders)
4. **Action items get binary resolution**: Each carry-over item is either completed or explicitly declassified — no indefinite carry-forward
5. **New infrastructure patterns get documented**: First use of any new NestJS feature (schedule, websockets, etc.) gets a pattern document in docs/

---

## Retrospective Meta

- **Duration**: Single session
- **Format**: Team dialogue (party-mode)
- **Key user input**: CQRS audit triggered by Monsieur's observation: "J'ai l'impression que cqrs a été oublié encore, sur cette epic"
- **Outcome**: 2 blocking action items, 3 improvement items, 5 team agreements
