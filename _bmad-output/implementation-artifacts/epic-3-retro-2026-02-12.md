# Epic 3 Retrospective — Tenant & Lease Management

**Date:** 2026-02-12
**Epic:** Epic 3 — Tenant & Lease Management (6 stories)
**Participants:** Monsieur (Project Lead), Bob (SM), Alice (PO), Charlie (Senior Dev), Dana (QA)

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories completed | 6/6 |
| Backend tests | 566 (78 suites) |
| Frontend tests | 317 (39 suites) |
| E2E tests | 14 (across stories) |
| New files | ~170 |
| Modified files | ~90 |
| New Bounded Contexts | 1 (Tenancy) |
| New Aggregates | 2 (TenantAggregate, LeaseAggregate) |

### Story Breakdown

| Story | Title | Tests (BE+FE) | Review Findings |
|-------|-------|---------------|-----------------|
| 3.1 | Register tenants with contact information | 305+216 | — (first story) |
| 3.2 | Track tenant insurance with expiry alerts | 355+235 | 7 fixes |
| 3.3 | Create a lease linking tenant to unit | 415+259 | — |
| 3.4 | Configure billing lines per lease | 458+281 | 18 fixes (incl. adversarial) |
| 3.5 | Configure lease revision parameters | 522+306 | 12 fixes |
| 3.6 | Terminate a lease with pro-rata calculation | 566+317 | 7 fixes |

## What Went Well

1. **New Bounded Context (Tenancy)**: Clean separation from Portfolio BC. TenantAggregate and LeaseAggregate in their own streams, cross-BC references by ID only.
2. **LeaseAggregate progressive growth**: Started with creation (3.3), added 3 mutations (billing lines, revision params, termination) across 3 stories. Aggregate stayed maintainable.
3. **Pro-rata as pure function**: `Math.floor((daysInPeriod * amountCents) / totalDaysInMonth)` — isolated, testable, no side effects.
4. **Test velocity**: Grew from 305+216 to 566+317 across the epic. Every story added meaningful coverage.
5. **Pattern maturity**: No-op guard (JSON.stringify comparison), 3-state detail display, PUT full replacement — all applied proactively from story to story.

## Discussion Points

### Controller Logic vs Aggregate Invariants (raised by Monsieur)

Key architectural discussion: why are authorization checks (EntityFinder, TenantFinder, LeaseFinder) in controllers rather than aggregate invariants?

**Resolution**: Two distinct concerns:
- **Aggregate invariants** (correctly in domain): protect own consistency (LeaseNotCreated, LeaseAlreadyTerminated)
- **Cross-aggregate authorization** (correctly in controllers): require read models that aggregates don't access in pure CQRS/ES

Cross-aggregate constraints like unit vacancy verification require querying other aggregate streams — this is controller/presentation layer responsibility. For more complex cross-aggregate rules in the future, a Domain Service or Process Manager would be appropriate.

### Promise.all for Parallel Finder Calls (raised by Monsieur)

`CreateALeaseController` had 4 sequential `await` calls to independent Finders. Refactored to a single `Promise.all` with consolidated validation guard.

**Action taken during retrospective**: Applied fix immediately. Pattern to follow for all future controllers with 2+ independent Finders.

## Previous Retrospective Action Items Follow-Through

| # | Action (from Consolidation Retro) | Status |
|---|-----------------------------------|--------|
| AI-1 | File List git verification | Partial — applied inconsistently |
| AI-2 | prisma generate automation | Not implemented (3rd carry-over) |
| AI-3 | E2E idempotency for prod | Not addressed (low priority) |
| AI-4 | YAGNI for helpers | Respected throughout Epic 3 |

## Action Items

| # | Action | Owner | Priority | Status |
|---|--------|-------|----------|--------|
| AI-1 | Promise.all on parallel Finder calls | — | — | Done (this retro) |
| AI-2 | Story 3.5/3.6 status review → done | — | — | Done (this retro) |
| AI-3 | prisma generate automation | Backlog | Low | Carry-over |
| AI-4 | Document `use(Promise)` anti-pattern for unit-tested components | Backlog | Low | Open |

## Epic 4 Readiness

**Epic 4: Rent Call Generation & Email Sending** (3 stories)

**Dependencies satisfied:**
- Active leases with billing lines (Epic 3) ✅
- Pro-rata calculation (Story 3.6) ✅
- Tenant contact information / emails (Story 3.1) ✅
- Revision parameters (Story 3.5) ✅

**New technical challenges:**
- First batch processing (iterate all active leases per entity)
- First infrastructure services (`infrastructure/document/`, `infrastructure/email/`)
- PDF generation (library TBD at implementation time)
- Email sending (library TBD at implementation time)
- Architecture already defines placement: infra services consumed via command bus

**Assessment:** Epic 4 is unblocked. All domain foundations from Epic 3 are in place.
