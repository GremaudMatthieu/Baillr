# Epic 7 Retrospective — Index Revision & Annual Charges

**Date:** 2026-02-15
**Epic:** Epic 7 — Index Revision & Annual Charges (10 stories)
**Participants:** Monsieur (Project Lead), Bob (SM), Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev)

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories completed | 10/10 |
| Backend tests | ~1,426 (215 suites) |
| Frontend tests | ~742 (95 suites) |
| E2E tests | ~29 |
| Total tests | ~2,197 |
| New files | ~214 |
| Modified files | ~184 |
| Deleted files | ~8 |
| Review findings | ~93 total across 10 reviews |
| Regressions | 0 |
| New Bounded Context | 1 (Indexation — 5th BC) |
| New Aggregates | 5 (InseeIndex, Revision, AnnualCharges, WaterMeterReadings, ChargeRegularization) |

### Story Breakdown

| Story | Title | New Files | Modified | Review Fixes | Key Pattern |
|-------|-------|-----------|----------|--------------|-------------|
| 7.1 | Enter and Validate INSEE Indices | 28 | 6 | 10 | New BC, immutable aggregate |
| 7.2 | Calculate Revised Rent Using Official Formula | 27 | 5 | 9 | Cross-entity security fix (H1) |
| 7.3 | Review and Batch-Approve Pending Revisions | 19 | 18 | 10 + arch refactor | Saga/Reaction pattern |
| 7.4 | Generate Revision Letters | 9 | 22 | 10 | CQRS chain gap (12 files) |
| 7.5 | Enter Actual Annual Charges by Category | 42 | 3 | 6 | Deterministic composite IDs |
| 7.5b | Add Charge Category to Billing Lines | 0 | 33 | 7 | Cross-BC VO dedup (H1) |
| 7.5c | Normalize Billing Lines with ChargeCategory Table | 10 | 67 (+5 del) | 11 | Largest refactoring in project |
| 7.6 | Enter Individual Water Meter Readings | 37 | 6 | 8 | Water distribution algorithm |
| 7.7 | Calculate and Generate Charge Regularization Statements | 35 | 8 | 10 | Complex cross-BC calculation service |
| 7.8 | Apply Regularization Credits/Debits to Tenant Accounts | 7 | 16 | 7 | Cross-stream subscription |

## What Went Well

1. **Saga/Reaction pattern (7.3)**: Clean cross-BC coordination via `RevisionApprovedReaction` (KurrentDB subscription → CommandBus → `ReviseLeaseRentHandler` in Tenancy). Zero cross-BC aggregate imports. Most significant architectural pattern of the epic.
2. **Mega-refactoring 7.5c without regression**: 67 modified files, 5 deleted, BillingLine JSON blob → normalized ChargeCategory table + LeaseBillingLine FK relation. Zero regressions — test pyramid holds.
3. **Deterministic composite IDs**: `{entityId}-{fiscalYear}` replaces UUIDs for temporal aggregates (7.5, 7.6, 7.7, 7.8). Natural idempotency without `@@unique`.
4. **French legal compliance**: Math.floor truncation (troncature légale), loi 89-462 legal mentions, décret 87-713 charge categories. Code reflects actual French rental law.
5. **Cross-BC multi-Finder orchestration (7.7)**: `RegularizationCalculationService` orchestrates 5 Finders from 3 BCs. Pro-rata by occupancy + water by actual consumption. Most complex calculation service in the project.
6. **Accelerating velocity on regularization chain (7.6→7.7→7.8)**: Patterns reused from revision chain. Story 7.8 is lean (7 new files) thanks to foundations laid earlier.
7. **Competitor validation**: Emjysoft Gestion Locative v2026 confirms our functional scope — charge entry + annual regularization with automated calculations is the market standard.

## Challenges

1. **Billing lines refactoring trilogy (7.5→7.5b→7.5c)**: Three passes on the same structure. 7.5 introduced charges, 7.5b added category to billing lines, 7.5c normalized everything. Could have anticipated normalization upfront. Costly rework on a cross-BC shared structure.
2. **DTO defense-in-depth still not systematic**: `@IsNotEmpty`, `@MaxLength` validators missing flagged as HIGH in 5 out of 10 reviews (7.1, 7.2, 7.5, 7.5b, 7.6). Checklist exists but not consistently applied.
3. **Stale closures in React hooks**: `useRef` guard needed in 3 stories (7.3, 7.4, 7.6) for async callbacks capturing stale values. No centralized pattern — each dev rediscovers the problem.
4. **Cache key mismatches**: Invalidation errors in 3 stories (7.3, 7.5, 7.8 H2). No documented dependency graph between query keys.
5. **Cross-entity security (7.2)**: Data leak via `findByTypeQuarterYear` without `entityId` filter. Caught in review, but could have reached production.
6. **File List accuracy**: Discrepancies between documented File List and actual `git status` in 6+ stories. Cosmetic but systemic since Epic 2.

## Critical Bug Found During Retrospective

**CRITICAL: Provisions at 0€ in charge regularization calculation**

The `RegularizationCalculationService` (Story 7.7) does NOT read lease billing lines to compute provisions paid by the tenant. The regularization displays "Provisions versées: 0,00€" for all categories even when the lease has provisions configured (e.g., Eau 200€/month, TEOM 300€/month).

**Impact:** Regularization results are completely wrong — they show the tenant owes the full charge amount instead of the difference between actual charges and provisions paid. This would generate incorrect regularization statements sent to tenants.

**Root cause:** The `RegularizationCalculationService` calculates provisions independently of lease billing lines. The `chargeCategoryId` added to billing lines in 7.5c was meant to enable this matching, but the regularization service doesn't use it.

**Fix:** Planned for Story C2-2 as priority #1. The service must read lease billing lines by `chargeCategoryId`, multiply monthly amount by months of occupation, and use that as "provisions versées" per category.

## Key Insights

1. **End-to-end flow matters more than isolated features**: Each story must be designed within the complete circuit (calculation → document → send → payment). The provisions bug proves it — the calculation worked in isolation, but the link to upstream data was missing.
2. **Anticipate normalization on cross-BC shared structures**: When a concept (VO/enum) crosses 2+ BCs, ask "table or enum?" upfront. The 7.5 trilogy cost significant rework.
3. **Saga/Reaction is the right cross-BC pattern**: Established in 7.3, reusable for Epic 8 account book (multi-stream projection).
4. **CQRS discipline must be maintained on presentation side**: C2-1 set the norm, every new story must respect it.
5. **User perspective catches what tests miss**: Monsieur found the critical provisions bug by asking a simple product question. 2,197 tests didn't catch it because test fixtures didn't reflect real-world data combinations.

## Breakthroughs

1. **Saga/Reaction pattern (7.3)**: `RevisionApprovedReaction` — KurrentDB subscription → CommandBus dispatch → cross-BC command handling. Zero aggregate coupling.
2. **ChargeCategory normalization (7.5c)**: Largest refactoring in project history — 67 modified files, zero regressions. Proves the testing pyramid holds under pressure.
3. **Deterministic composite IDs**: `{entityId}-{fiscalYear}` for temporal aggregates. Natural idempotency, simpler testing.
4. **Cross-BC multi-Finder orchestration (7.7)**: 5 Finders from 3 BCs coordinated in a single calculation service. Pro-rata by occupancy + water by consumption.
5. **Competitor validation**: Emjysoft confirms the functional scope is market-standard. Confidence in product direction.

## Previous Retrospective Action Items Follow-Through

| # | Action (from Epic 5 Retro) | Status | Evidence |
|---|----------------------------|--------|----------|
| AI-1 | Promise.all systematic on independent Finders | ⏳ Partial | Applied in some controllers but not systematic |
| AI-2 | Document cache key dependency graph | ❌ Not done | Cache key mismatch flagged H2 in 7.8 |
| AI-3 | Reinforce DTO defense-in-depth checklist | ⏳ Partial | @IsNotEmpty flagged HIGH in 5/10 reviews |
| AI-4 | Centralize Intl.NumberFormat jsdom workaround | ❌ Not done | Not encountered in Epic 7 (no complex currency formatting) |
| AI-5 | File List git verification | ⏳ Partial | Gaps still present in 6+ stories |
| AI-6 | prisma generate automation | ❌ Not done | 5th consecutive carry-over |

**Assessment:** 0/6 completed, 3/6 partial, 3/6 not addressed. Action item follow-through remains a systemic issue.

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| AI-1 | Anticipate normalization on cross-BC shared structures — when a VO/enum is used in 2+ BCs, ask "do we need a table?" in the story that introduces it | Convention | Zero refactoring trilogies like 7.5→7.5b→7.5c |
| AI-2 | DTO defense-in-depth: integrate checklist as mandatory self-check BEFORE review | Convention | 0 HIGH findings for @IsNotEmpty/@MaxLength in reviews |
| AI-3 | Document `useRef` guard pattern in `docs/anti-patterns.md` for async React callbacks | Charlie | Section added with copy-paste example |

### Technical Debt

| # | Action | Owner | Priority |
|---|--------|-------|----------|
| TD-1 | Cache key dependency graph — document in `docs/` which query key to invalidate for each mutation | Backlog | High |
| TD-2 | Promise.all systematic on independent Finders — audit + fix existing controllers | Backlog | Medium |
| TD-3 | prisma generate automation — `postinstall` hook in backend package.json | Charlie | Immediate (no more carry-over) |

### Team Agreements

1. **DTO self-check before review**: Dev verifies `docs/dto-checklist.md` before submitting for review
2. **Cross-BC structure = ask the table question**: When a VO/enum crosses 2+ BCs, evaluate if a normalized table is needed
3. **entityId isolation systematic**: Every Finder query MUST include `entityId` in WHERE, verified in review
4. **Stale closure = useRef guard**: Every async callback in a React hook that depends on state must use the `useRef` pattern
5. **CQRS presentation discipline**: Maintain the normalization from C2-1 in every new story — Finders in presentation, no PrismaService in handlers

## Consolidation Sprint 2 — Story C2-2

**Title:** Close open circuits from Epic 7

**Blocker:** C2-2 must be DONE before Epic 8 starts.

| # | Task | Priority | Description |
|---|------|----------|-------------|
| 1 | Fix RegularizationCalculationService — integrate provisions from lease billing lines by chargeCategoryId | **CRITICAL** | Service must read lease billing lines, match by chargeCategoryId, multiply monthly amount × months occupied |
| 2 | E2E test revision → rent call with revised amount | High | Verify revised rent amount is used in next generated rent call |
| 3 | Send regularization statement by email to tenant | High | Controller + handler + `markAsSent` on ChargeRegularizationAggregate, same pattern as 4.3 |
| 4 | UI error on ChargeCategory deletion | Medium | Intercept Prisma `onDelete: Restrict`, display explicit message ("Category used by X leases") |
| 5 | Mark regularization as settled | Medium | `markAsSettled` on aggregate + UI button + projection |
| 6 | ActionFeed for unsettled regularizations | Medium | Alert "X regularizations sent, awaiting settlement" |

## Critical Path

| # | Item | Owner | Blocker |
|---|------|-------|---------|
| 1 | C2-2 — Close open circuits from Epic 7 | Team | Blocks Epic 8 |
| 2 | TD-3 — prisma generate automation | Charlie | Immediate |
| 3 | TD-1 — Cache key dependency graph | Backlog | Before Epic 8 |

## Epic 8 Readiness

**Epic 8: Dashboard, Accounting & Monitoring** (8 stories)

**Dependencies satisfied:**

| Capability | Source | Status |
|------------|--------|--------|
| AccountEntryProjection | Epic 5.5 + 7.8 | ✅ Ready (pending C2-2 provisions fix) |
| ChargeCategory table | Epic 7.5c | ✅ Ready |
| All financial data (revisions, charges, regularizations) | Epic 7 | ✅ Ready |
| CQRS query-side normalized | C2-1 | ✅ Ready |
| EmailService | Epic 4.3 | ✅ Ready |
| PDF generation | Epic 4.2 | ✅ Ready |

**New challenges for Epic 8:**
- Event-sourced account book with multi-stream projection (8.1)
- Month-aware dashboard context (team agreement from Epic 5)
- Data visualization library selection for treasury chart (8.7)
- Cron/background job architecture for email alerts (8.8)
- Excel export library selection for 2072 tax declaration (8.3)

**Blockers:** C2-2 must be completed first.

**Assessment:** Epic 8 is unblocked once C2-2 is done. Functional scope validated by competitor analysis (Emjysoft). Primary challenge is presentation/visualization, not domain logic.

## Significant Discoveries

**CRITICAL: Provisions calculation bug in RegularizationCalculationService**

The regularization calculation does not integrate lease billing line provisions by charge category. This produces incorrect regularization statements (provisions shown as 0€, tenant charged full amount). Fix planned as C2-2 priority #1.

**No discoveries that invalidate Epic 8 planning.** The Epic 8 plan is sound. The critical bug affects Epic 7 output quality, not Epic 8 architecture.
