# generated: 2026-02-08
# project: Baillr
# project_key: NOKEY
# tracking_system: file-system
# story_location: _bmad-output/implementation-artifacts

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic not yet started
#   - in-progress: Epic actively being worked on
#   - done: All stories in epic completed
#
# Epic Status Transitions:
#   - backlog → in-progress: Automatically when first story is created (via create-story)
#   - in-progress → done: Manually when all stories reach 'done' status
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - ready-for-dev: Story file created in stories folder
#   - in-progress: Developer actively working on implementation
#   - review: Implementation complete, ready for review
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - done: Retrospective has been completed
#
# WORKFLOW NOTES:
# ===============
# - Epic transitions to 'in-progress' automatically when first story is created
# - Stories can be worked in parallel if team capacity allows
# - SM typically creates next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', then runs code-review (fresh context, different LLM recommended)

generated: 2026-02-08
project: Baillr
project_key: NOKEY
tracking_system: file-system
story_location: _bmad-output/implementation-artifacts

development_status:
  # Epic 1: Project Foundation & Authentication (4 stories)
  epic-1: done
  1-1-initialize-repository-and-development-environment: done
  1-2-configure-clerk-authentication-with-jwt-verification: done
  1-3-implement-core-layout-shell-with-responsive-design: done
  1-4-create-empty-dashboard-with-action-feed-placeholder: done
  epic-1-retrospective: optional

  # Epic 2: Portfolio Setup — Entities, Properties & Units (6 stories)
  epic-2: done
  2-1-create-and-manage-ownership-entities: done
  2-2-associate-bank-accounts-to-an-entity: done
  2-3-implement-entity-switcher-component: done
  2-4-create-properties-under-an-entity: done
  2-5-create-and-configure-units-within-a-property: done
  2-6-display-unit-mosaic-on-dashboard: done
  epic-2-retrospective: done

  # Consolidation Sprint — Testing & Anti-Patterns (3 stories, blocking Epic 3)
  consolidation: done
  c-1-setup-vitest-and-retrotest-epic2-frontend: done
  c-2-setup-playwright-e2e-onboarding-scenarios: done
  c-3-centralize-antipatterns-and-dto-checklist: done
  consolidation-retrospective: done

  # Epic 3: Tenant & Lease Management (6 stories)
  epic-3: done
  3-1-register-tenants-with-contact-information: done
  3-2-track-tenant-insurance-with-expiry-alerts: done
  3-3-create-a-lease-linking-tenant-to-unit: done
  3-4-configure-billing-lines-per-lease: done
  3-5-configure-lease-revision-parameters: done
  3-6-terminate-a-lease-with-pro-rata-calculation: done
  epic-3-retrospective: done

  # Epic 4: Rent Call Generation & Email Sending (3 stories)
  epic-4: done
  4-1-generate-rent-calls-for-all-active-leases-in-batch: done # reviewed 2026-02-13, 20 findings + 2 arch fixes
  4-2-generate-rent-call-pdf-documents: done # reviewed 2026-02-13, 12 findings + CORS fix
  4-3-send-rent-calls-by-email-in-batch-with-pdf-attachments: done # reviewed 2026-02-13, 14 findings, 10 fixes — CQRS boundary (domain interfaces), RFC 5322 quoting, dead tenantName field, React key, E2E anti-pattern, contentType generic, DTO @IsNotEmpty, assembler Prisma decoupling, format-tenant-name tests, totalFormatted escape
  epic-4-retrospective: optional

  # Epic 5: Bank Reconciliation & Payment Management (6 stories)
  epic-5: done
  5-1-import-bank-statements-from-csv-excel: done
  5-2-auto-match-payments-to-rent-calls: done
  5-3-validate-reject-or-manually-assign-payment-matches: done # reviewed 2026-02-14, 12+15 findings, 10+14 fixes — pass 1: bankStatementId traceability, DTO validation, E2E URL, responsive stepper, dark mode, fragile selector, hook tests; pass 2 (adversarial): CRITICAL cross-entity auth bypass, bankStatementId null semantics, non-deterministic aggregate, event validation, double-click guard, availableRentCalls server-side, DTO dedup, line-through badge, E2E conditional assertion
  5-4-record-manual-payments-cash-check: done # reviewed 2026-02-14, 9 findings, 9 fixes — @IsString/@Max DTO H1+H2, || vs ?? M1, dialog useEffect sync M2, double-click guard M3, neutral default icon M5, already-paid test L1, E2E value type L2, File List gap L3
  5-5-handle-partial-payments-overpayments-and-tenant-current-account: done # reviewed 2026-02-14, 9 findings (3H/4M/2L), 9 fixes — @@unique idempotency (Payment+AccountEntry), cache invalidation tenant account, event validation parity, unused userId removal, scalar fields partial-payment guard, File List sync, paidAt guard, overpayment comment
  5-6-generate-receipts-quittances-and-partial-payment-receipts: done # reviewed 2026-02-14, 12 findings (2H/5M/5L), 10 fixes — phantom File List entry, AC 9 title alignment, DRY download helper, sanitizeForFilename spaces, billingLines type widening, fixture email field, explicit mock, pdf-constants extraction, unused HttpCode import
  epic-5-retrospective: done

  # Epic 6: Unpaid Rent Management & Reminders (5 stories)
  epic-6: done
  6-1-detect-late-payments-and-display-unpaid-status: done # reviewed 2026-02-14, 10 findings (2H/5M/3L), 7 fixes — DTO @IsNotEmpty/@Type, unpaid cache invalidation, E2E assertion robustness, E2E selector alignment, UnitMosaic sent color regression, timezone normalization
  6-2-propose-3-tier-escalation-actions: done # reviewed 2026-02-14, 10 findings (3H/5M/2L), 12 fixes — dead code exceptions removed (H1), N+1 batch endpoint (H2), success icon (H3), unused imports/constants (M1/M2), @IsString DTO (M3), File List sync (M4/M5), table name (L2), type errors (bonus), re-stage (L1)
  6-3-send-email-reminders-tier-1: done # absorbed by 6.2 — Tier 1 email reminder fully implemented (controller, handler, template, frontend hook, E2E)
  6-4-generate-formal-notices-mise-en-demeure-tier-2: done # absorbed by 6.2 — Tier 2 formal notice PDF fully implemented (controller, handler, template, assembler, frontend hook, E2E)
  6-5-generate-stakeholder-notification-letters-tier-3: done # absorbed by 6.2 — Tier 3 stakeholder letters fully implemented (controller, handler, template, assembler, frontend hook)
  epic-6-retrospective: optional

  # Epic 7: Index Revision & Annual Charges (8 stories)
  epic-7: done
  7-1-enter-and-validate-insee-indices-irl-ilc-icc: done # reviewed 2026-02-14, 12 findings (3H/4M/3L), 10 fixes — @IsNotEmpty DTO H1, dead DuplicateIndexException removed H2, form.reset timing H3, GET type validation M1, finder userId consistency M2, E2E AC#6 duplicate test M3, IndexValue float decimal fix M4, duplicate error display L1, file list count L2, empty module removed L3
  7-2-calculate-revised-rent-using-official-formula: done # reviewed 2026-02-14, 10 findings (3H/4M/3L), 9 fixes — cross-entity data leak (entityId on findByTypeQuarterYear), dead code exceptions removed, double-click guard, error display, useRevisions tests, test rename, E2E selector
  7-3-review-and-batch-approve-pending-revisions: done # reviewed 2026-02-14, 12 findings (2H/6M/4L), 10 fixes + Saga/Reaction arch refactor — cross-BC decoupled via RevisionApprovedReaction (KurrentDB subscription → CommandBus dispatch → ReviseLeaseRentHandler in Tenancy BC), zero cross-BC aggregate imports
  7-4-generate-irl-ilc-icc-revision-letters: done # reviewed 2026-02-14, 10 fixes — baseIndexYear missing from CQRS chain (H1, 12 files), useRef download guard (M2+M5), template test coverage (M4), UTC date formatting (L2), @HttpCode removal (L1), E2E simplification (L3)
  7-5-enter-actual-annual-charges-by-category: done # reviewed 2026-02-14, 12 findings (1C/3H/4M/4L), 6 fixes — repository.load() for rehydration (C1), label tooLong() factory (H1), DTO @MaxLength id (H2), InvalidChargeAmountException rename (M3), File List count fix (M1), no-op guard handler test
  7-5b-add-charge-category-to-billing-lines: done # reviewed 2026-02-14, 10 findings (1H/5M/4L), 7 fixes — duplicate BillingLineCategory→ChargeCategory cross-BC import (H1), Zod enum validation (M2), File List sync (M1), type safety casts
  7-5c-normalize-billing-lines-with-charge-category-table: done # reviewed 2026-02-15, 10 findings (1H/5M/4L), 11 fixes — H1: 5 test fixtures stale format, M1: unscoped findByIds removed, M4: debug.png cleaned, M5: onDelete Restrict FK, L1: File List count 10→12, L2: use-charge-categories hook tests (4 tests), L3: seeder sequential→createMany batch, L4: E2E api fixture methods
  7-6-enter-individual-water-meter-readings-per-unit: done # reviewed 2026-02-15, 10 findings (3H/4M/3L), 8 fixes — type mismatch H1, null-guard chargeCategoryId H2, DTO deviation doc H3, role="status" M2, File List count M4, consumption null-guards in 2 components + 2 tests
  7-7-calculate-and-generate-charge-regularization-statements: done # reviewed 2026-02-15, 12 findings (4H/5M/3L), 10 fixes — AlertDialog H1, TenantFinder/UnitFinder CQRS H2, lastName firstName H3, chargeCategoryId filter H4, Math.floor M1, unsafe cast M2, date DD/MM/YYYY M3, CORS header M4, unitAddress PDF M5, formatCurrency DRY L1
  7-8-apply-regularization-credits-debits-to-tenant-accounts: done # reviewed 2026-02-15, 7 findings (2H/3M/2L), 7 fixes — cache invalidation key mismatch H2, missing E2E tenant detail test H1, uncalculated aggregate guard M1, Prisma comment M2, .js extension M3
  epic-7-retrospective: done # 2026-02-15 — 10 stories, ~2197 tests, CRITICAL bug found (provisions 0€ in regularization), C2-2 story defined (6 tasks), 3 AI + 3 TD + 5 team agreements

  # Epic 8: Dashboard, Accounting & Monitoring (8 stories)
  epic-8: done
  8-1-implement-event-sourced-account-book-livre-de-comptes: done # reviewed 2026-02-16, 12 findings (2H/6M/4L), 12 fixes — tenantId-filtered getTotalBalance H2, tablet responsive hidden lg:table-cell H1, Prisma.AccountEntryWhereInput typed where M1, GetAccountBookQueryParamsDto with class-validator M2, green payment badge M4, UTC timezone date parsing M5, SQL query test verification M6, removed unused export L1, backend getAvailableCategories L2, aria-label table L3, removed redundant "use client" L4, File List count M3
  8-2-view-and-filter-the-account-book: done # absorbed by 8.1 — page, table, filters (date range, category, tenant), summary, responsive, 42 tests all already delivered in Story 8.1
  8-3-export-account-book-as-excel-for-2072-tax-declaration: done # reviewed 2026-02-16, 9 findings (1H/5M/3L), 7 fixes — CATEGORY_LABELS sync comment H1, unused param removed M1, grand total balance added M2, click test added M3, fake timers determinism M5, file count fix L1, number format applied L2
  8-4-display-dashboard-with-unit-payment-status-mosaic: done # reviewed 2026-02-18, 12 findings (1C/3H/6M/2L), 10 fixes — middleware.ts rename reverted (C1), controller destructuring (H4), dead findAllByEntityAndMonth removed (M3), STATUS_LABELS consolidated (M4), 5 buildTooltipContent tests (M5), E2E legend 5/5 + perf 3s (H3/M6), File List corrected (H1/H2/M1/M2)
  8-5-display-kpis-and-collection-rate: done # reviewed 2026-02-18, 8 findings (1H/5M/2L), 7 fixes — formatTrendPercent minus sign (H1), DTO month regex strict (M1), unpaidCount sentAt filter (M4), dead code placeholder deleted (M5), outstandingDebt comments (M2/M3), Dev Notes E2E path (L2)
  8-6-display-action-feed-with-pending-tasks: done # reviewed 2026-02-18, 7 findings (2H/4M/1L), 7 fixes — formatRelativeDate future dates bug (H1), missing revision timestamp (H2), use-revisions mock in 3 test suites (M1), formatRelativeDate behavioral tests +6 (M2), E2E assertion robustness (M3), revision timestamp test (M4)
  8-7-display-treasury-chart-income-vs-expenses-over-time: done # reviewed 2026-02-18, 10 findings (2H/5M/3L), 7 fixes — CSS custom properties dark mode (H1), formatCurrency DRY (H2), no-entity test gap (M1), finder start month precision (M3), formatCompactEur 1.5k (M4), DTO default test (L1), recharts pinned (L3)
  8-8-send-email-alerts-for-critical-events: done # reviewed 2026-02-18, 9 findings (3H/4M/2L), 9 fixes — Clerk email resolution (H3), escalation amount display (H1), @IsIn DTO validation (H2), batch findSentReferenceIds N+1→batch (M2), BCC same-email guard (M3), dead escapeHtml import (M4), File List count (M1), @ArrayMinSize (L1), .js extensions (L2)
  epic-8-retrospective: done # 2026-02-18 — 8 stories, ~2473 tests, CQRS audit: 8.8 fully non-compliant (5 violations), 8.5+8.7 missing QueryBus layer, 2 blocking AIs + 3 improvement AIs, 5 team agreements

  # Consolidation Sprint 2 — CQRS Query-Side Normalization (blocking Epic 8)
  consolidation-2: done
  c2-1-normalize-cqrs-query-side-across-all-presentation-modules: done # reviewed 2026-02-15, 10 findings (2H/5M/3L), 10 fixes — syntax error INSEE controller, PrismaService→Finder in provisions handler, duplicate interfaces extracted, unsafe cast typed, return type annotations, File List accuracy
  c2-2-close-open-circuits-from-epic-7: done # reviewed 2026-02-16, 10 findings (3H/4M/3L), 10 fixes — entityId scoping on findBillingLinesByLeaseIds + deleteChargeCategory, await res.json(), settle tests, cache invalidation plural key, email trim, settle isSent guard, multi-tenant batch test, CircleDollarSign icon

  # Epic 9: Integrations & Advanced Features (4 stories)
  epic-9: in-progress
  9-1-connect-to-bank-via-open-banking-api: done # reviewed 2026-02-19 (pass 1: 12 findings, 10 fixes), pass 2: 2026-02-20 (10 findings, 6 fixes — H1-H3 accepted GoCardless→Bridge, M1 date normalization, M2 deleteItem throws, M4 HTTPS redirect validation, M5 accountIds runtime check, L1 soft delete, L2 staleTime 5min)
  9-2-send-registered-mail-via-ar24-maileva-integration: backlog
  9-3-automatic-insee-index-retrieval: backlog
  9-4-grant-accountant-read-only-access: backlog
  epic-9-retrospective: optional
