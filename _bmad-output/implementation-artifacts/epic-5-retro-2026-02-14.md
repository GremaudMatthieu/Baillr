# Epic 5 Retrospective — Bank Reconciliation & Payment Management

**Date:** 2026-02-14
**Epic:** Epic 5 — Bank Reconciliation & Payment Management (6 stories)
**Participants:** Monsieur (Project Lead), Bob (SM), Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev)

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories completed | 6/6 |
| Backend tests | 899 (117 suites) |
| Frontend tests | 546 (68 suites) |
| E2E tests | 19 |
| Total tests | 1,464 |
| New files | ~101 |
| Modified files | ~85 |
| Review findings | 45 total (12H / 25M / 8L) |
| Regressions | 0 |
| Bounded Contexts extended | 1 (Billing) |
| New Prisma models | 4 (BankStatement, BankTransaction, Payment, AccountEntry) |

### Story Breakdown

| Story | Title | Tests (BE+FE) | Review Fixes | Pattern Maturity |
|-------|-------|---------------|--------------|------------------|
| 5.1 | Import bank statements from CSV/Excel | 730+404 | 11 | LOW (new parser logic) |
| 5.2 | Auto-match payments to rent calls | 796+438 | 12 | LOW (new algorithm) |
| 5.3 | Validate, reject, or manually assign payment matches | 814+480 | 12 | MEDIUM |
| 5.4 | Record manual payments (cash, check) | 829+505 | 9 | HIGH (extension) |
| 5.5 | Handle partial payments, overpayments, tenant current account | 861+530 | 9 | HIGH |
| 5.6 | Generate receipts (quittances) and partial payment receipts | 899+546 | 10 | HIGH (template reuse) |

## What Went Well

1. **Pattern maturity**: 0 HIGH review findings from Story 5.4 onwards. Patterns reused systematically across stories.
2. **Ephemeral matching architecture (5.2)**: Match proposals computed on-the-fly, not persisted as events. Good CQRS/ES judgment — not everything needs to be an aggregate.
3. **ContinuousFlowStepper**: First multi-step UI component. Visual anchor for the entire epic (Import → Match → Validate → Complete).
4. **Backward-compatible event extension**: PaymentRecorded extended cleanly with paymentMethod/paymentReference across 3 stories. Null Object pattern in event handlers.
5. **Running balance via AccountEntryProjection (5.5)**: Elegant debit/credit tracking per tenant. Foundation for Epics 6, 7, 8.
6. **Test coverage**: 899 backend + 546 frontend + 19 E2E, 0 regressions. Testing pyramid respected — heavy unit/component, light E2E (happy paths only).
7. **Legal compliance**: Quittance vs Reçu distinction (loi 89-462, article 21) correctly implemented with automatic routing based on paymentStatus.

## Challenges

1. **Intl.NumberFormat jsdom pitfall**: Narrow no-break space (`\u202F`) in real browsers vs regular space in jsdom. Hit in 3 stories (5.1, 5.5, 5.6). No centralized solution yet — using `.` wildcard in regex case by case.
2. **Cache invalidation growing complexity**: From 2 query keys in 5.3 to 5 in 5.5. No documented dependency graph between cache keys. Fragile — relies on developer knowledge.
3. **DTO defense-in-depth**: `@Min`, `@MaxLength` validators missing flagged as HIGH in 3 reviews (5.3, 5.4, 5.6). Checklist exists but not consistently applied.
4. **File List phantom entries**: 3rd consecutive epic with inaccurate file lists in story documents. Cosmetic but recurring.
5. **Promise.all not systematic**: Sequential await on independent Finders still appears. Action item from Epic 3 retro, still not a reflex.

## Key Insights

1. **Domain never depends on Presentation**: Domain Services, Aggregates, VOs must never import Finders or Prisma. Controller is the bridge — it orchestrates Finders (Presentation) and passes data to Domain.
2. **Controller orchestrates, Domain Service decides**: When controller logic exceeds 2-3 lines of business decisions, extract to a Domain Service. The Domain Service receives data as parameters, never fetches.
3. **Dashboard is not month-aware**: UnitMosaic shows current state without month filtering. ActionFeed uses implicit current month. Critical to address for Epic 8 (KPIs need explicit month context with selector).
4. **E2E test strategy is intentionally light**: 19 E2E tests for 6 stories is by design. Testing pyramid: heavy unit/component (1,445), light E2E (happy paths only). Each E2E tests a real flow with Clerk auth, real API, real Postgres.
5. **KPI data available since Epic 5**: Collection rate, rent calls generated, payments received, unpaid count — all computable from existing data. Display deferred to Epic 8.

## Breakthroughs

1. **Payment status enum (5.5)**: 4-state progression (null → partial → paid → overpaid) unlocked UnitMosaic coloring and receipt type routing.
2. **Ephemeral matching (5.2)**: Pure service computation, no event sourcing overhead for transient proposals. O(n×m) < 100ms.
3. **Running balance computation (5.5)**: AccountEntryProjection with referenceId+category idempotency. Query-time balance at any historical point.
4. **Quittance vs Reçu legal distinction (5.6)**: Single controller/assembler/template with routing based on paymentStatus. French law compliance built into architecture.
5. **Multi-payment aggregate (5.5)**: RentCallAggregate extended to support multiple PaymentRecorded events. Legacy single-payment events replay correctly via backward-compatible handler.

## Previous Retrospective Action Items Follow-Through

| # | Action (from Epic 3 Retro) | Status |
|---|----------------------------|--------|
| AI-1 | Promise.all on parallel Finder calls | ⏳ Applied in some controllers but not systematic |
| AI-2 | Story status review → done | ✅ Done |
| AI-3 | prisma generate automation | ❌ 4th carry-over |
| AI-4 | Document `use(Promise)` anti-pattern | ⏳ Pattern used but not formally documented |

**Assessment:** 1/4 completed, 2/4 partial, 1/4 not addressed. Promise.all discipline remains a recurring theme.

## Action Items

| # | Action | Owner | Priority |
|---|--------|-------|----------|
| AI-1 | Promise.all systematic on independent Finders | Convention | High |
| AI-2 | Document cache key dependency graph in `docs/` | Backlog | Medium |
| AI-3 | Reinforce DTO defense-in-depth checklist application | Convention | Medium |
| AI-4 | Centralize Intl.NumberFormat jsdom workaround | Backlog | Medium |
| AI-5 | File List git verification | Backlog | Low |
| AI-6 | prisma generate automation | Backlog | Low |

## Team Agreements

1. **Domain/Presentation separation**: Domain (aggregates, VOs, Domain Services) has zero dependencies on Presentation (Finders, Prisma). Never.
2. **Controller orchestrates, Domain Service decides**: Extract when logic exceeds 2-3 lines of business decisions in controller.
3. **Promise.all mandatory**: For 2+ independent Finder calls — no sequential awaits.
4. **Dashboard month-aware**: Epic 8 requires a global `selectedMonth` context on dashboard with month selector.

## Epic 6 Readiness

**Epic 6: Unpaid Rent Management & Reminders** (5 stories)

**Dependencies satisfied:**

| Capability | Source | Status |
|------------|--------|--------|
| Late payment detection | rent_calls + payments query | ✅ Ready |
| Email reminders | EmailService (Epic 4.3) | ✅ Ready |
| PDF formal notices | PdfGeneratorService (Epic 4.2/5.6) | ✅ Ready |
| Tenant current account | AccountEntryProjection (Epic 5.5) | ✅ Ready |
| UnitMosaic red (unpaid) | Color pattern extension | ✅ Pattern established |

**New challenges for Epic 6:**
- Late payment detection logic (when is a rent call considered unpaid?)
- StatusTimeline UI for 3-tier escalation visualization
- Formal notice (mise en demeure) PDF template with legal mentions
- Stakeholder notification letter templates

**Blockers:** None identified.

**Assessment:** Epic 6 is unblocked. All technical foundations from Epics 4-5 are in place. Primary challenge is legal/business content, not technical infrastructure.

## Significant Discoveries

No significant discoveries that would invalidate Epic 6 planning. The plan is sound.

**Note for Epic 8:** Dashboard will need architectural change (month-aware context) — flag during Epic 8 planning.
