# Epic 2 Retrospective — Portfolio Setup: Entities, Properties & Units

**Date:** 2026-02-11
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 2 — Portfolio Setup: Entities, Properties & Units
**Status:** Complete (6/6 stories)

## Team Participants

- **Monsieur** (Project Lead)
- **Bob** (Scrum Master — Facilitator)
- **Alice** (Product Owner)
- **Charlie** (Senior Developer)
- **Dana** (QA Engineer)
- **Elena** (Junior Developer)

## Epic 2 Summary

### Delivery Metrics

| Metric | Value |
|--------|-------|
| Stories completed | 6/6 (100%) |
| Total tasks | 46 |
| Backend tests | 234 (39 suites) |
| Frontend tests | 0 (deferred — addressed in action items) |
| Files produced | ~170 (new + modified) |
| Code review fixes | 71 total (declining trend: 18 → 7 → 12 → 19 → 9 → 6) |
| Debug issues | 15 total (declining trend: 5 → 2 → 2 → 3 → 3 → 0) |
| Production incidents | 0 |

### Stories Delivered

| Story | Theme | Tasks | Tests Added | Review Fixes | Debug Issues |
|-------|-------|-------|-------------|-------------|-------------|
| 2.1 | Create and manage ownership entities | 9 | 70 | 18 (2 passes) | 5 |
| 2.2 | Associate bank accounts to an entity | 9 | +39 (109 total) | 7 | 2 |
| 2.3 | Implement entity switcher component | 7 | 0 (frontend only) | 12 (2 passes) | 2 |
| 2.4 | Create properties under an entity | 8 | +43 (151 total) | 19 (2 passes) | 3 |
| 2.5 | Create and configure units within a property | 8 | +67 (227 total) | 9 | 3 |
| 2.6 | Display unit mosaic on dashboard | 5 | +7 (234 total) | 6 | 0 |

### Business Outcomes

- FR1-FR8 fully covered (entities, bank accounts, properties, units, mosaic)
- Complete onboarding journey: entity → bank → property → units → mosaic
- ActionFeed data-driven with progressive contextual guidance
- UnitMosaic with ARIA grid accessibility, responsive design, property grouping

## What Went Well

### 1. CQRS/ES Full-Stack Patterns Established and Reused
Story 2.1 established the complete CQRS/Event Sourcing stack (aggregate, commands, events, projections, SRP controllers, optimistic updates). Every subsequent story reused these patterns with minimal friction. By Story 2.5, the UnitAggregate was built by following the PropertyAggregate template almost identically.

### 2. Velocity Improvement Through Pattern Maturity
Clear declining trend in both review fixes (18 → 6) and debug issues (5 → 0). The team learned from each code review and proactively applied lessons. Named domain exceptions were flagged as Critical in 2.4, then proactively built into 2.5 and 2.6.

### 3. Coherent Onboarding UX
The ActionFeed progressively guides users through onboarding steps, driven by real data (not hardcoded). Each story enriched the feed contextually: entity → bank account → property → unit.

### 4. Robust Backend Test Suite
234 tests across 39 suites with zero regressions. Every aggregate, command handler, controller, and projection has unit tests. Test count grew steadily with each story.

### 5. Reusable Architectural Patterns
- Separate aggregate pattern (Property, Unit — own event streams)
- Child entities in aggregate (bank accounts, billable options — Map<string, State>)
- Dual URL pattern (sub-resource for create/list, direct for get/update)
- Cross-aggregate authorization (controller-level via Finder)
- Null Object pattern for optional VOs (.empty() + .isEmpty)
- Composite VO pattern (fromPrimitives(), toPrimitives())

### 6. Advanced Frontend Patterns
- "Sync state during render" for React Compiler compatibility
- Optimistic updates with 1500ms delayed invalidation (masks CQRS/ES latency)
- Entity context with localStorage persistence and pure derivation
- ARIA grid with roving tabindex for UnitMosaic accessibility

## What Didn't Go Well

### 1. Frontend Tests Deferred 6 Consecutive Times
vitest + @testing-library setup was marked as "deferred" in every single story. Zero frontend tests exist. The code review is the only safety net for UI code — fragile and not scalable.

### 2. Anti-Patterns Rediscovered Across Stories
- **Prisma `generate` after migration** — required in stories 2.1, 2.2, 2.5. Each time caused mysterious lint failures that took time to diagnose.
- **Zod `.default()`/`.refine()` with zodResolver** — broke type inference in stories 2.1 and 2.2. Same mistake made twice before establishing the anti-pattern.
- **React Compiler strictness** — setState in useEffect and useRef during render flagged in 2.3, applied afterward.

### 3. DTO Defense-in-Depth Consistently Missed
`@Max`, `@MaxLength`, `@ArrayMaxSize` decorators were added via code review in 4 out of 6 stories. The development agent does not spontaneously apply defense-in-depth validation on DTOs — it's always caught by the reviewer.

### 4. Test Coverage Gaps Flagged in Every Review
Missing test files (handler tests, controller tests, edge cases) were identified in every code review. Test completeness is not part of the development agent's natural workflow.

### 5. Lessons Learned Stay in Individual Stories
Anti-patterns and conventions documented in Dev Notes of one story are not automatically available to subsequent stories. Each story rediscovers known issues instead of referencing a central knowledge base.

## Key Insights

1. **Pattern maturity is measurable** — Story 2.6 delivered with zero debug issues and only 6 review fixes, proving the patterns are stable and well-understood.

2. **Code review is the single point of failure for frontend quality** — Without automated tests, all frontend quality depends on the reviewer catching issues. This doesn't scale.

3. **Uncentralized lessons are lost lessons** — When anti-patterns live only in individual story files, they get rediscovered instead of avoided.

4. **The investment in Story 2.1 paid massive dividends** — Despite being the heaviest story (18 review fixes, 5 debug issues), it established every pattern reused across the epic.

5. **Declining review fixes prove team learning** — The trend from 18 to 6 shows the development agent internalizes feedback and applies it proactively.

## Previous Retrospective Follow-Through

This is the first retrospective. No previous commitments to evaluate. This document establishes the baseline for future retrospective continuity.

## Significant Discovery Analysis

**No significant discoveries that invalidate Epic 3 planning.** All Epic 2 dependencies for Epic 3 are complete and stable:
- Entity aggregate with bank accounts ✅
- Property aggregate with dual URL pattern ✅
- Unit aggregate with billable options ✅
- UnitMosaic ready for lease status integration ✅
- Cross-BC event architecture documented ✅

The only blocker for Epic 3 is the team's deliberate decision to invest in a testing consolidation sprint first.

## Next Epic Preview — Epic 3: Tenant & Lease Management

### Overview
6 stories covering FR9-FR17: tenant registration, insurance tracking with expiry alerts, lease creation, billing lines, revision parameters, and lease termination with pro-rata calculation.

### Dependencies on Epic 2 (all satisfied)
- Entities, Properties, Units all available and stable
- UnitMosaic ready for status color integration (gray → green on lease)
- Cross-BC communication via events documented in architecture

### New Complexities
- **New Bounded Context**: Tenancy BC (first inter-BC communication)
- **Scheduled jobs**: Insurance expiry daily check (Story 3.2)
- **Financial calculations**: Pro-rata in integer cents with rounding (Story 3.6)
- **French rental law domain**: IRL/ILC/ICC indices, revision formulas (Story 3.5)

## Readiness Assessment

| Dimension | Status | Notes |
|-----------|--------|-------|
| Backend testing & quality | ✅ Solid | 234 tests, 39 suites, 0 regressions |
| Frontend testing & quality | ⚠️ Consolidation sprint planned | 0 tests — Action Items 4 & 5 |
| Deployment | ℹ️ Local only | No production pressure |
| Stakeholder acceptance | ✅ Approved | Project Lead: "top tier" |
| Technical health | ✅ Solid | Mature patterns, improving quality trend |
| Unresolved blockers | ✅ None | Only blocker = planned testing sprint |

## Action Items

### Process Improvements

**AI-1: Centralize anti-patterns in story templates**
- Owner: Charlie (Senior Dev)
- Success criteria: Each future story contains known anti-patterns (Zod/zodResolver, Prisma generate, React Compiler, DTO defense-in-depth) directly in Dev Notes section
- Scope: Enrich story template with pre-filled "Known Anti-Patterns" section

**AI-2: Automate `prisma generate` after each migration**
- Owner: Charlie (Senior Dev)
- Success criteria: Post-migration script or hook that automatically runs `prisma generate` — no more mysterious lint failures after `migrate dev`

**AI-3: DTO defense-in-depth checklist**
- Owner: Dana (QA)
- Success criteria: Every DTO with numeric fields has `@Max`, every string has `@MaxLength`, every array has `@ArrayMaxSize` — verifiable via code review checklist

### Technical Debt — Testing (CRITICAL — Blocking Epic 3)

**AI-4: Setup vitest + @testing-library + full retro-testing of Epic 2**
- Owner: Charlie (Senior Dev) + Elena (Junior Dev)
- Priority: CRITICAL — blocks Epic 3
- Scope:
  - Setup vitest + @testing-library/react + jsdom
  - Unit tests: PropertyForm, UnitForm, UnitMosaic, EntitySwitcher, ActionFeed, DashboardContent
  - Hook tests: useEntities, useProperties, useUnits, useCurrentEntity (including optimistic updates)
  - Schema tests: property-schema, unit-schema (validation edge cases)
  - Page tests: properties list/new/detail, units new/detail, dashboard
- Success criteria: Full coverage of all Epic 2 frontend components, CI green

**AI-5: Setup Playwright E2E + onboarding scenarios**
- Owner: Dana (QA) + Elena (Junior Dev)
- Priority: CRITICAL — blocks Epic 3
- Scope:
  - Setup Playwright with multi-browser configuration
  - E2E scenario: complete onboarding flow (create entity → add bank → create property → create unit → see mosaic)
  - E2E scenario: entity, property, unit editing
  - E2E scenario: entity switcher navigation
- Success criteria: E2E suite passing, integrated into validation workflow

### Team Agreements

1. No story can be marked "done" without frontend tests for new components
2. Every code review verifies the DTO defense-in-depth checklist
3. Anti-patterns discovered during development are added to the story template within 24h
4. `prisma generate` is automated — no more manual debugging post-migration

## Critical Path (Before Epic 3)

| # | Item | Owner | Must Complete Before |
|---|------|-------|---------------------|
| 1 | Setup vitest + full retro-tests of Epic 2 frontend | Charlie + Elena | Story 3.1 start |
| 2 | Setup Playwright + E2E onboarding scenarios | Dana + Elena | Story 3.1 start |
| 3 | Centralize anti-patterns + DTO checklist | Charlie + Dana | Story 3.1 start |

## Commitments Summary

| Category | Count |
|----------|-------|
| Action Items | 5 |
| Preparation Tasks | 6 |
| Critical Path Items | 3 |
| Team Agreements | 4 |

## Closing Notes

Epic 2 delivered 6 stories with 100% completion, established mature CQRS/ES patterns reused across the entire epic, and demonstrated clear velocity improvement (review fixes: 18 → 6, debug issues: 5 → 0). The team's deliberate decision to invest in a testing consolidation sprint before Epic 3 reflects engineering maturity — building on solid foundations rather than accumulating technical debt.

Project Lead's closing words: **"En avant toute !"**

---
*Retrospective facilitated by Bob (Scrum Master) on 2026-02-11*
*First retrospective — establishes baseline for future continuity*
